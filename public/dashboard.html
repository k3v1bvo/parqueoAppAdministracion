<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ParqueoApp Â· Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <div id="toast" class="toast"></div>
  <style>
    .cards{display:grid;gap:14px;grid-template-columns:1fr}
    @media(min-width:992px){.cards{grid-template-columns:repeat(3,1fr)}}
    .card{background:#0b1220;border:1px solid #1f2937;border-radius:16px;padding:16px}
    .kpi{display:flex;align-items:center;gap:12px}
    .kpi .ico{width:44px;height:44px;border-radius:12px;display:grid;place-items:center}
    .ico--open{background:rgba(250,204,21,.15);border:1px solid rgba(250,204,21,.45)}
    .ico--today{background:rgba(56,189,248,.18);border:1px solid rgba(56,189,248,.45)}
    .ico--cash{background:rgba(34,197,94,.18);border:1px solid rgba(34,197,94,.45)}
    .value{font-weight:800;font-size:22px}
    .table-wrap{overflow:auto}
  </style>
</head>
<body>
  <nav class="topbar">
    <strong>ğŸ  Dashboard</strong>
    <span id="currentUser"></span>
    <div class="spacer"></div>
    <button id="menuToggle" class="menu-toggle">â˜°</button>
    <div id="navLinks" class="links">
      <a href="ingresos.html">ğŸš˜ Tickets</a>
      <a href="planes.html">ğŸ“… Planes</a>
      <a href="tarifas.html">ğŸ’² Tarifas</a>
      <a href="admin.html">ğŸ›¡ï¸ Admin</a>
      <button onclick="AuthUI.logout()">Salir</button>
    </div>
  </nav>

  <main class="container">
    <section class="cards">
      <div class="card kpi">
        <div class="ico ico--open">â³</div>
        <div>
          <div class="text-muted">Tickets abiertos</div>
          <div id="kpiAbiertos" class="value">0</div>
        </div>
      </div>
      <div class="card kpi">
        <div class="ico ico--today">ğŸ“…</div>
        <div>
          <div class="text-muted">Tickets creados hoy</div>
          <div id="kpiHoy" class="value">0</div>
        </div>
      </div>
      <div class="card kpi">
        <div class="ico ico--cash">ğŸ’µ</div>
        <div>
          <div class="text-muted">Recaudado hoy (tickets + extra âˆ’ egresos)</div>
          <div id="kpiRecaudo" class="value mono">0.00</div>
        </div>
      </div>
    </section>

    <section class="card mt-3">
      <h3>ğŸ§¾ Tickets recientes</h3>
      <div class="table-wrap">
        <table class="table table-dark table-borderless align-middle">
          <thead><tr>
            <th>Placa</th><th>Tipo</th><th>Estado</th><th>Entrada</th><th>Salida</th><th>Total</th>
          </tr></thead>
          <tbody id="tbodyRecientes"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="auth.js"></script>
  <script>
    const safeN = (x)=> Number(x||0);

    (async ()=>{
      await AuthUI.requireLogin();

      document.getElementById('menuToggle').addEventListener('click', ()=>{
        document.getElementById('navLinks').classList.toggle('open');
      });

      await cargarKPIs();
      await cargarRecientes();

      async function cargarKPIs(){
        const { data: ab } = await supa
          .from('tickets').select('id').eq('estado','ingresado');
        document.getElementById('kpiAbiertos').textContent = (ab||[]).length;

        const start = new Date(); start.setHours(0,0,0,0);
        const end   = new Date(); end.setHours(23,59,59,999);
        const sISO = start.toISOString(), eISO = end.toISOString();

        const { data: hoy } = await supa
          .from('tickets').select('id')
          .gte('hora_entrada', sISO).lte('hora_entrada', eISO);
        document.getElementById('kpiHoy').textContent = (hoy||[]).length;

        const { data: tks } = await supa.from('tickets')
          .select('costo_total,hora_salida,estado')
          .gte('hora_salida', sISO).lte('hora_salida', eISO)
          .eq('estado','pagado');

        const { data: ex } = await supa.from('ingresos_extra')
          .select('monto,creado_at')
          .gte('creado_at', sISO).lte('creado_at', eISO);

        const { data: eg } = await supa.from('egresos_admin')
          .select('monto,creado_at')
          .gte('creado_at', sISO).lte('creado_at', eISO);

        const sum = (arr, k)=> (arr||[]).reduce((a,b)=> a + safeN(b[k]), 0);
        const total = sum(tks,'costo_total') + sum(ex,'monto') - sum(eg,'monto');
        document.getElementById('kpiRecaudo').textContent = total.toFixed(2);
      }

      async function cargarRecientes(){
        const { data } = await supa
          .from('tickets')
          .select('placa_vehiculo,tipo_vehiculo,estado,hora_entrada,hora_salida,costo_total')
          .order('hora_entrada',{ascending:false})
          .limit(10);

        const tb = document.getElementById('tbodyRecientes');
        tb.innerHTML = (data||[]).map(t=>`
          <tr>
            <td class="mono">${t.placa_vehiculo}</td>
            <td>${t.tipo_vehiculo}</td>
            <td>${t.estado}</td>
            <td>${t.hora_entrada ? new Date(t.hora_entrada).toLocaleString() : '-'}</td>
            <td>${t.hora_salida  ? new Date(t.hora_salida ).toLocaleString() : '-'}</td>
            <td class="mono">${safeN(t.costo_total).toFixed(2)}</td>
          </tr>
        `).join('') || `<tr><td colspan="6" class="text-muted">Sin datos</td></tr>`;
      }
    })();
  </script>
</body>
</html>
