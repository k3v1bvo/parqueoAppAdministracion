<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ingresos extra</title>
  <link rel="stylesheet" href="style.css" />
  <div id="toast" class="toast"></div>
</head>
<body>
  <nav class="topbar">
    <strong>🧾 Ingresos extra</strong>
    <span id="currentUser"></span>
    <div class="spacer"></div>

    <button id="menuToggle" class="menu-toggle">☰</button>
    <div id="navLinks" class="links">
      <a href="dashboard.html">🏠 Dashboard</a>
      <a href="ingresos.html">➕ Tickets</a>
      <a href="tarifas.html">💲 Tarifas</a>
      <a href="admin.html" id="linkAdmin" style="display:none;">🛡️ Admin</a>
      <button onclick="AuthUI.logout()">Salir</button>
    </div>
  </nav>

  <main class="container">
    <section class="card">
      <h2>➕ Registrar ingreso extra</h2>
      <form id="formExtra" class="row g-3">
        <div class="col-12 col-md-8">
          <label class="form-label">Concepto</label>
          <input name="concepto" class="form-control" placeholder="Ej: Baño, Lavado, Venta de agua" required />
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Monto (Bs)</label>
          <input name="monto" type="number" step="0.01" class="form-control" placeholder="0.00" required />
        </div>
        <div class="col-12 d-grid">
          <button class="btn btn-primary" type="submit">Guardar</button>
        </div>
      </form>
      <p id="infoExtra" class="text-muted mt-2"></p>
    </section>

    <section class="card">
      <h2>📅 Mis ingresos de hoy</h2>
      <div class="table-wrap">
        <table class="table table-dark table-borderless align-middle">
          <thead><tr><th>Hora</th><th>Concepto</th><th class="text-end">Monto</th></tr></thead>
          <tbody id="tbodyExtras"></tbody>
          <tfoot>
            <tr><td></td><td class="text-end"><strong>Total</strong></td><td class="mono text-end" id="totalExtras">0.00</td></tr>
          </tfoot>
        </table>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="auth.js"></script>
  <script>
    (async ()=>{
      await AuthUI.requireAuth();
      if (await ParkingAPI.isAdmin()) document.getElementById('linkAdmin').style.display='inline-flex';

      const info = document.getElementById('infoExtra');
      const form = document.getElementById('formExtra');
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const f=e.target;
        try{
          await ParkingAPI.crearIngresoExtra({ concepto: f.concepto.value.trim(), monto: f.monto.value });
          toast('Ingreso guardado'); f.reset(); renderExtras();
        }catch(err){ const m=err?.message||String(err); info.textContent='❌ '+m; toast(m,false); }
      });

      async function renderExtras(){
        const {desdeISO, hastaISO} = ParkingAPI.todayRange();
        const rows = await ParkingAPI.listarIngresosExtra({desdeISO, hastaISO});
        const tb = document.getElementById('tbodyExtras');
        let total = 0;
        tb.innerHTML = rows.map(r=>{
          total += Number(r.monto||0);
          return `<tr>
            <td>${new Date(r.creado_at).toLocaleTimeString()}</td>
            <td>${r.concepto}</td>
            <td class="mono text-end">${Number(r.monto||0).toFixed(2)}</td>
          </tr>`;
        }).join('') || `<tr><td colspan="3" class="text-muted">Sin ingresos hoy</td></tr>`;
        document.getElementById('totalExtras').textContent = total.toFixed(2);
      }
      renderExtras();
    })();
  </script>
</body>
</html>
