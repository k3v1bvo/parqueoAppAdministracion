<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tickets · ParqueoApp</title>
  <link rel="stylesheet" href="style.css" />
  <div id="toast" class="toast"></div>
  <style>
    .grid-2{display:grid;gap:18px}
    @media(min-width:992px){.grid-2{grid-template-columns:1fr 1fr}}
    .card{background:#0b1220;border:1px solid #1f2937;border-radius:14px;padding:16px}
    .mono{font-variant-numeric:tabular-nums}
    .table-wrap{overflow:auto}
    .badge{padding:4px 8px;border-radius:8px;background:#065f46}
    .admin-badge{display:none}
    body.admin .admin-badge{display:inline-block}
    datalist option{color:#000}
  </style>
</head>
<body>
  <nav class="topbar">
    <strong>🚘 Tickets</strong>
    <span id="currentUser"></span>
    <div class="spacer"></div>
    <button id="menuToggle" class="menu-toggle">☰</button>
    <div id="navLinks" class="links">
      <a href="dashboard.html">🏠 Dashboard</a>
      <a href="planes.html">📅 Planes</a>
      <a href="tarifas.html">💲 Tarifas</a>
      <a href="admin.html">🛡️ Admin</a>
      <button onclick="AuthUI.logout()">Salir</button>
    </div>
  </nav>

  <main class="container">
    <div class="grid-2">
      <!-- Abrir ticket -->
      <section class="card">
        <h2>➕ Abrir ticket (Entrada)</h2>
        <label class="form-label">Placa</label>
        <input id="inPlaca" class="form-control" placeholder="Ej: ABC 123" />
        <div class="row g-3 mt-2">
          <div class="col-6">
            <label class="form-label">Tipo de vehículo</label>
            <select id="inTipo" class="form-select">
              <option value="auto">Auto</option>
              <option value="moto">Moto</option>
              <option value="bicicleta">Bicicleta</option>
            </select>
          </div>
          <div class="col-6">
            <label class="form-label">Categoría</label>
            <select id="inCat" class="form-select">
              <option value="normal">Cliente normal (día 15)</option>
              <option value="frecuente">Cliente frecuente (día 12)</option>
            </select>
          </div>
        </div>
        <button id="btnAbrir" class="btn btn-primary mt-3">Abrir ticket</button>
        <p class="hint mt-2">Reglas: Día 08:00–19:59 → Normal 15 / Frecuente 12. Noche (20:00–07:59) → 12. Si excede y no cierra → 7 primera hora + 1 extra/h.</p>
      </section>

      <!-- Cerrar ticket -->
      <section class="card">
        <h2>✅ Cerrar ticket (Salida)</h2>
        <label class="form-label">Placa (sugerencias de abiertas)</label>
        <input id="outPlaca" list="opcPlacas" class="form-control" placeholder="Empieza a escribir..." />
        <datalist id="opcPlacas"></datalist>

        <label class="form-label mt-2">Tipo de pago</label>
        <div class="row">
          <div class="col-6"><label><input type="radio" name="pago" value="efectivo" checked /> Efectivo</label></div>
          <div class="col-6"><label><input type="radio" name="pago" value="qr" /> QR</label></div>
        </div>

        <button id="btnCerrar" class="btn btn-success mt-3">Cerrar ticket</button>
        <div id="cerrarMsg" class="mono mt-2"></div>
      </section>
    </div>

    <!-- Tickets abiertos (admin puede cerrar manual) -->
    <section class="card mt-3">
      <h3>⏳ Tickets abiertos <span class="admin-badge badge">Admin</span></h3>
      <div class="table-wrap">
        <table class="table table-dark table-borderless align-middle">
          <thead><tr>
            <th>Placa</th><th>Tipo</th><th>Cat.</th><th>Entrada</th><th>Operador</th><th class="text-end">Acción</th>
          </tr></thead>
          <tbody id="tbodyAbiertos"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="auth.js"></script>
  <script>
    (async ()=>{
      await AuthUI.requireLogin();
      const { data: { session } } = await supa.auth.getSession();
      const isAdmin = (session?.user?.app_metadata?.role||'') === 'admin';
      if(isAdmin) document.body.classList.add('admin');

      // Toggle menú móvil
      document.getElementById('menuToggle').addEventListener('click', ()=>{
        document.getElementById('navLinks').classList.toggle('open');
      });

      // Cargar sugerencias y lista abiertos
      await cargarSugerencias();
      await cargarAbiertos();

      // Abrir
      document.getElementById('btnAbrir').addEventListener('click', async ()=>{
        const placa = document.getElementById('inPlaca').value.trim();
        const tipo  = document.getElementById('inTipo').value;
        const cat   = document.getElementById('inCat').value;
        if(!placa){ toast('Ingresa la placa', false); return; }
        try{
          await ParkingAPI.crearTicket({ placa, tipoVehiculo:tipo, categoria:cat });
          toast('Ticket abierto');
          document.getElementById('inPlaca').value='';
          await cargarSugerencias(); await cargarAbiertos();
        }catch(e){ toast(e.message||String(e), false); }
      });

      // Cerrar
      document.getElementById('btnCerrar').addEventListener('click', async ()=>{
        const placa = document.getElementById('outPlaca').value.trim();
        const pago = document.querySelector('input[name="pago"]:checked').value;
        if(!placa){ toast('Ingresa la placa para cerrar', false); return; }
        try{
          const total = await ParkingAPI.cerrarTicket({ placa, tipo_pago:pago });
          document.getElementById('cerrarMsg').textContent = `Cobrado: ${Number(total).toFixed(2)} Bs`;
          toast('Ticket cerrado');
          document.getElementById('outPlaca').value='';
          await cargarSugerencias(); await cargarAbiertos();
        }catch(e){ toast(e.message||String(e), false); }
      });

      async function cargarSugerencias(){
        const placas = await ParkingAPI.placasAbiertas();
        const dl = document.getElementById('opcPlacas');
        dl.innerHTML = placas.map(p=>`<option value="${p}">`).join('');
      }

      async function cargarAbiertos(){
        const list = await ParkingAPI.listarAbiertos();
        const tb = document.getElementById('tbodyAbiertos');
        tb.innerHTML = (list||[]).map(t => `
          <tr>
            <td class="mono">${t.placa_vehiculo}</td>
            <td>${t.tipo_vehiculo}</td>
            <td>${t.categoria||'-'}</td>
            <td>${new Date(t.hora_entrada).toLocaleString()}</td>
            <td>${t.operador_id ? t.operador_id.slice(0,6)+'…' : '-'}</td>
            <td class="text-end">
              ${isAdmin ? `<button class="btn btn-danger btn-sm" data-id="${t.id}">Cerrar manual</button>` : ''}
            </td>
          </tr>
        `).join('') || `<tr><td colspan="6" class="text-muted">Sin abiertos</td></tr>`;

        if(isAdmin){
          tb.querySelectorAll('button[data-id]').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              const id = btn.getAttribute('data-id');
              if(!confirm('¿Cerrar este ticket manualmente?')) return;
              try{
                await ParkingAPI.cerrarTicketManual(id);
                toast('Cerrado manual');
                await cargarSugerencias(); await cargarAbiertos();
              }catch(e){ toast(e.message||String(e), false); }
            });
          });
        }
      }
    })();
  </script>
</body>
</html>
