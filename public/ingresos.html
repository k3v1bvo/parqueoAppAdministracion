<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Entradas / Salidas - Parqueo</title>
  <link rel="stylesheet" href="style.css" />
  <div id="toast" class="toast"></div>
</head>
<body>
  <nav class="topbar">
    <strong>ğŸš˜ ParqueoApp</strong>
    <span id="currentUser"></span>
    <div class="spacer"></div>
    <button id="menuToggle" class="menu-toggle">â˜°</button>
    <div id="navLinks" class="links">
      <a href="dashboard.html">ğŸ  Dashboard</a>
      <a href="planes.html">ğŸ“… Planes</a>
      <a href="tarifas.html">ğŸ’² Tarifas</a>
      <a href="extras.html">ğŸ§¾ Ingresos extra</a>
      <a href="admin.html" id="linkAdmin" style="display:none;">ğŸ›¡ï¸ Admin</a>
      <button onclick="AuthUI.logout()">Salir</button>
    </div>
  </nav>

  <main class="container">
    <div class="row g-4">
      <!-- Abrir ticket -->
      <section class="col-12 col-lg-6">
        <div class="card">
          <h2>â• Abrir ticket (Entrada)</h2>

          <label class="form-label">Placa</label>
          <input id="inPlaca" class="form-control" placeholder="Ej: ABC 123" />
          <div id="inPlanInfo" class="chip mt-1" style="display:none"></div>

          <label class="form-label mt-2">Tipo de vehÃ­culo</label>
          <select id="inTipo" class="form-select">
            <option value="auto">Auto</option>
            <option value="moto">Moto</option>
            <option value="bicicleta">Bicicleta</option>
          </select>

          <button id="btnAbrir" class="btn btn-success mt-3">Abrir ticket</button>
        </div>
      </section>

      <!-- Cerrar ticket -->
      <section class="col-12 col-lg-6">
        <div class="card">
          <h2>âœ… Cerrar ticket (Salida)</h2>

          <label class="form-label">Placa</label>
          <input id="outPlaca" class="form-control" placeholder="Ej: abc 123" />
          <div id="outPlanInfo" class="chip mt-1" style="display:none"></div>

          <label class="form-label mt-2">Tipo de pago</label>
          <div class="radio-group">
            <label><input type="radio" name="pay" value="efectivo" checked /> ğŸ’µ Efectivo</label>
            <label><input type="radio" name="pay" value="qr" /> ğŸ“± QR</label>
          </div>

          <button id="btnCerrar" class="btn btn-success mt-3">Cerrar ticket</button>
        </div>
      </section>
    </div>

    <section class="card mt-4">
      <h2>â³ Tickets abiertos</h2>
      <div class="table-wrap">
        <table class="table table-dark table-borderless align-middle">
          <thead>
            <tr><th>Placa</th><th>Tipo</th><th>Entrada</th><th>Estado</th></tr>
          </thead>
          <tbody id="tbodyAbiertos"></tbody>
        </table>
      </div>
      <p class="text-muted">Tip: las placas se normalizan (sin espacios y en MAYÃšSCULAS) al guardar y al buscar.</p>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="auth.js"></script>
  <script>
    const ICON = (t) => t==='moto' ? 'ğŸ›µ Moto' : (t==='bicicleta' ? 'ğŸš² Bicicleta' : 'ğŸš— Auto');

    (async ()=>{
      await AuthUI.requireAuth();
      if (await ParkingAPI.isAdmin()) document.getElementById('linkAdmin').style.display='inline-flex';

      const inPlaca = document.getElementById('inPlaca');
      const outPlaca = document.getElementById('outPlaca');
      const inInfo = document.getElementById('inPlanInfo');
      const outInfo = document.getElementById('outPlanInfo');

      async function showPlan(elInput, elChip){
        const placa = elInput.value;
        if(!placa){ elChip.style.display='none'; elChip.textContent=''; return; }
        try{
          const plan = await ParkingAPI.planActivoPorPlaca(placa);
          if(plan){
            elChip.textContent = `ğŸ“… Plan activo: ${plan.nombre} (${plan.tipo}${plan.tipo==='mensual'?'':' Â· '+Number(plan.precio).toFixed(2)+' Bs'})`;
            elChip.style.display='inline-flex';
          }else{
            elChip.textContent = 'Sin plan activo';
            elChip.style.display='inline-flex';
          }
        }catch(e){ console.warn(e); elChip.style.display='none'; }
      }

      inPlaca.addEventListener('input', ()=> showPlan(inPlaca, inInfo));
      outPlaca.addEventListener('input', ()=> showPlan(outPlaca, outInfo));

      document.getElementById('btnAbrir').addEventListener('click', async ()=>{
        const placa = inPlaca.value;
        const tipo  = document.getElementById('inTipo').value;
        try{
          await ParkingAPI.abrirTicket({ placa, tipoVehiculo: tipo });
          toast('Ticket abierto');
          inPlaca.value=''; inInfo.style.display='none';
          await cargarAbiertos();
        }catch(e){ toast(e.message||String(e), false); }
      });

      document.getElementById('btnCerrar').addEventListener('click', async ()=>{
        const placa = outPlaca.value;
        const forma = document.querySelector('input[name="pay"]:checked').value;
        try{
          const res = await ParkingAPI.cerrarTicketPorPlaca(placa, forma);
          toast(res.plan ? `Cerrado con plan (${res.plan}) Â· Bs ${res.costo.toFixed(2)}` : `Cerrado Â· Bs ${res.costo.toFixed(2)}`);
          outPlaca.value=''; outInfo.style.display='none';
          await cargarAbiertos();
        }catch(e){ toast(e.message||String(e), false); }
      });

      async function cargarAbiertos(){
        const rows = await supa
          .from('tickets')
          .select('placa_vehiculo,tipo_vehiculo,hora_entrada,estado')
          .eq('estado','ingresado')
          .order('hora_entrada',{ascending:false});

        const tb = document.getElementById('tbodyAbiertos');
        if(rows.error){
          tb.innerHTML = `<tr><td colspan="4" class="text-muted">Error: ${rows.error.message}</td></tr>`;
          return;
        }
        tb.innerHTML = (rows.data||[]).map(r=>`
          <tr>
            <td class="mono">${r.placa_vehiculo}</td>
            <td>${ICON(r.tipo_vehiculo)}</td>
            <td>${new Date(r.hora_entrada).toLocaleString()}</td>
            <td><span class="badge badge-open">Abierto</span></td>
          </tr>
        `).join('') || `<tr><td colspan="4" class="text-muted">No hay tickets abiertos</td></tr>`;
      }

      await cargarAbiertos();

      document.getElementById('menuToggle').addEventListener('click', ()=>{
        document.getElementById('navLinks').classList.toggle('open');
      });
    })();
  </script>
</body>
</html>
