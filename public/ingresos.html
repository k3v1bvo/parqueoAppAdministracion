<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tickets ¬∑ Entradas/Salidas</title>
<link rel="stylesheet" href="style.css" />
<div id="toast" class="toast"></div>
<style>
  .card h2,.card h3{margin:0 0 10px}
  .badge{padding:.2rem .5rem;border-radius:9999px;font-size:.8rem}
  .badge-open{background:rgba(250,204,21,.15);border:1px solid rgba(250,204,21,.4);color:#fde68a}
  .pill{padding:.25rem .6rem;border:1px solid #1f2937;border-radius:9999px;font-size:.8rem;color:#9fb0c5}
  .input-inline{display:flex;gap:8px;align-items:center}
  .muted{color:#94a3b8;font-size:.9rem}
  .btn-danger{background:#ef4444;border:0}
  .btn-primary{background:#22c55e;border:0}
  .btn-blue{background:#38bdf8;border:0}
</style>
</head>
<body>
  <nav class="topbar">
    <strong>üöò Tickets</strong>
    <span id="currentUser"></span>
    <div class="spacer"></div>
    <button id="menuToggle" class="menu-toggle">‚ò∞</button>
    <div id="navLinks" class="links">
      <a href="dashboard.html">üè† Dashboard</a>
      <a class="active" href="ingresos.html">üöò Tickets</a>
      <a href="planes.html">üìÖ Planes</a>
      <a href="tarifas.html">üí≤ Tarifas</a>
      <a href="extras.html">üßæ Ingresos extra</a>
      <button onclick="AuthUI.logout()">Salir</button>
    </div>
  </nav>

  <main class="container">
    <section class="row g-3">
      <!-- ENTRADA -->
      <div class="col-12 col-lg-6">
        <div class="card">
          <h2>‚ûï Abrir ticket (Entrada)</h2>
          <label class="form-label">Placa</label>
          <input id="inPlaca" class="form-control" placeholder="Ej: ABC 123" autocomplete="off">

          <div class="row g-3 mt-2">
            <div class="col-6">
              <label class="form-label">Tipo de veh√≠culo</label>
              <select id="inTipo" class="form-select">
                <option value="auto">Auto</option>
                <option value="moto">Moto</option>
                <option value="bicicleta">Bicicleta</option>
              </select>
            </div>
            <div class="col-6">
              <label class="form-label">Modalidad</label>
              <select id="inCategoria" class="form-select">
                <option value="por_hora" selected>Por hora</option>
                <option value="diario_normal">Diario normal (15)</option>
                <option value="diario_frecuente">Diario frecuente (12)</option>
                <option value="noche">Noche (12 hasta 20:00)</option>
                <option value="dia_y_noche_22">D√≠a + Noche (22)</option>
                <option value="dia_y_noche_25">D√≠a + Noche (25)</option>
              </select>
            </div>
          </div>

          <button id="btnAbrir" class="btn btn-primary mt-3">Abrir ticket</button>
        </div>
      </div>

      <!-- SALIDA -->
      <div class="col-12 col-lg-6">
        <div class="card">
          <h2>‚úÖ Cerrar ticket (Salida)</h2>
          <label class="form-label">Placa</label>
          <input id="outPlaca" class="form-control" placeholder="Escribe para sugerencias‚Ä¶" list="listaPlacas">
          <datalist id="listaPlacas"></datalist>

          <div class="row g-3 mt-2">
            <div class="col-6">
              <label class="form-label">Pago</label>
              <div class="input-inline">
                <label class="pill"><input type="radio" name="pago" value="efectivo" checked> Efectivo</label>
                <label class="pill"><input type="radio" name="pago" value="qr"> QR</label>
              </div>
            </div>
            <div class="col-6">
              <label class="form-label">Costo estimado</label>
              <input id="outPreview" class="form-control" readonly value="0.00">
            </div>
          </div>

          <button id="btnCerrar" class="btn btn-blue mt-3">Cerrar ticket</button>
        </div>
      </div>
    </section>

    <!-- ABIERTOS -->
    <section class="card mt-3">
      <h3>‚è≥ Tickets abiertos</h3>
      <div class="table-wrap">
        <table class="table table-dark table-borderless align-middle">
          <thead><tr>
            <th>Placa</th><th>Tipo</th><th>Modalidad</th><th>Entrada</th><th>Estado</th><th class="text-end">Acci√≥n</th>
          </tr></thead>
          <tbody id="tbodyAbiertos"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="auth.js"></script>
  <script>
  const precios = { diario_normal:15, diario_frecuente:12, noche:12, dia_y_noche_22:22, dia_y_noche_25:25, p_primera:7, p_extra:1, corte_noche:'20:00' };
  let abiertos = [];

  // helpers
  const fmt = n => Number(n||0).toFixed(2);
  const normalizarPlaca = p => (p||'').toUpperCase().replace(/\s+/g,'').trim();

  // --- detectar plan activo por placa
  async function getPlanActivo(placa){
    const { data:veh } = await supa.from('vehiculos').select('id').eq('placa',placa).maybeSingle();
    if(!veh) return null;
    const { data:plan } = await supa.from('vehiculos_planes').select('*')
      .eq('vehiculo_id',veh.id).eq('activo',true)
      .order('desde',{ascending:false}).limit(1).maybeSingle();
    return plan||null;
  }

  function calcularCosto(t,salida,plan){
    const e=new Date(t.hora_entrada);
    const cat=t.categoria||'por_hora';
    if(plan){
      if(['diario_normal','diario_frecuente','noche','dia_y_noche_22','dia_y_noche_25'].includes(plan.plan))
        return Number(plan.precio||0);
    }
    if(cat==='diario_normal')return precios.diario_normal;
    if(cat==='diario_frecuente')return precios.diario_frecuente;
    if(cat==='dia_y_noche_22')return precios.dia_y_noche_22;
    if(cat==='dia_y_noche_25')return precios.dia_y_noche_25;
    if(cat==='noche'){
      const corte=new Date(e);const [hh,mm]=precios.corte_noche.split(':').map(Number);
      corte.setHours(hh,mm||0,0,0);
      if(salida<=corte)return precios.noche;
      return precios.noche+calcularPorHora(corte,salida);
    }
    return calcularPorHora(e,salida);
  }
  const calcularPorHora=(a,b)=>{const ms=Math.max(0,b-a);const h=Math.ceil(ms/36e5);return h<=1?precios.p_primera:precios.p_primera+(h-1)*precios.p_extra;}

  async function listarAbiertos(){
    const {data,error}=await supa.from('tickets').select('*').eq('estado','ingresado').order('hora_entrada',{ascending:false});
    if(error)return toast(error.message,false);
    abiertos=data||[];
    const tb=document.getElementById('tbodyAbiertos');
    tb.innerHTML=abiertos.map(t=>`
      <tr>
        <td>${t.placa_vehiculo}</td>
        <td>${t.tipo_vehiculo}</td>
        <td>${t.categoria}</td>
        <td>${new Date(t.hora_entrada).toLocaleString()}</td>
        <td><span class="badge badge-open">Abierto</span></td>
        <td class="text-end"><button class="btn btn-blue btn-sm" onclick="cerrarManual('${t.placa_vehiculo}')">Cerrar</button></td>
      </tr>
    `).join('') || `<tr><td colspan="6" class="muted">No hay tickets abiertos.</td></tr>`;
    document.getElementById('listaPlacas').innerHTML = abiertos.map(x=>`<option value="${x.placa_vehiculo}">`).join('');
  }

  async function abrirTicket(){
    const placa=normalizarPlaca(document.getElementById('inPlaca').value);
    const tipo=document.getElementById('inTipo').value;
    const catSel=document.getElementById('inCategoria');
    let cat=catSel.value;
    if(!placa)return toast('Ingresa placa',false);
    const plan=await getPlanActivo(placa);
    if(plan){cat=plan.plan;catSel.value=cat;catSel.disabled=true;}
    let {data:veh}=await supa.from('vehiculos').select('id').eq('placa',placa).maybeSingle();
    if(!veh){const ins=await supa.from('vehiculos').insert({placa}).select('id').single();veh=ins.data;}
    const {error}=await supa.from('tickets').insert({placa_vehiculo:placa,tipo_vehiculo:tipo,categoria:cat,estado:'ingresado'});
    if(error)return toast(error.message,false);
    toast('Ticket abierto');
    document.getElementById('inPlaca').value='';
    catSel.disabled=false;
    await listarAbiertos();
  }

  async function cerrarTicket(){
    const placa=normalizarPlaca(document.getElementById('outPlaca').value);
    if(!placa)return toast('Ingresa placa',false);
    const {data}=await supa.from('tickets').select('*').eq('placa_vehiculo',placa).eq('estado','ingresado').limit(1);
    if(!data.length)return toast('No hay abierto',false);
    const t=data[0];const plan=await getPlanActivo(placa);
    const costo=calcularCosto(t,new Date(),plan);
    const pago=document.querySelector('input[name="pago"]:checked').value;
    const {error}=await supa.from('tickets').update({estado:'pagado',hora_salida:new Date().toISOString(),costo_total:costo,tipo_pago:pago}).eq('id',t.id);
    if(error)return toast(error.message,false);
    toast('Cerrado Bs '+fmt(costo));
    await listarAbiertos();
  }

  function cerrarManual(p){
    document.getElementById('outPlaca').value=p;
    cerrarTicket();
  }

  async function init(){
    await AuthUI.requireLogin();
    document.getElementById('menuToggle').onclick=()=>document.getElementById('navLinks').classList.toggle('open');
    document.getElementById('btnAbrir').onclick=abrirTicket;
    document.getElementById('btnCerrar').onclick=cerrarTicket;
    await listarAbiertos();
  }
  init();
  </script>
</body>
</html>
