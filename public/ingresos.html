<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Entradas / Salidas - Parqueo</title>
  <link rel="stylesheet" href="style.css" />
  <div id="toast" class="toast"></div>
</head>
<body>
  <!-- √öNICO NAVBAR -->
  <nav class="topbar">
    <strong>üöò ParqueoApp</strong>
    <span id="currentUser"></span>
    <div class="spacer"></div>

    <button id="menuToggle" class="menu-toggle">‚ò∞</button>
    <div id="navLinks" class="links">
      <a href="dashboard.html">üè† Dashboard</a>
      <a href="tarifas.html">üí≤ Tarifas</a>
      <a href="extras.html">üßæ Ingresos extra</a>
      <a href="admin.html" id="linkAdmin" style="display:none;">üõ°Ô∏è Admin</a>
      <button onclick="AuthUI.logout()">Salir</button>
    </div>
  </nav>

  <main class="container">
    <div class="row g-4">
      <!-- Abrir ticket -->
      <section class="col-12 col-lg-6">
        <div class="card">
          <h2>‚ûï Abrir ticket (Entrada)</h2>

          <label class="form-label">Placa</label>
          <input id="inPlaca" class="form-control" placeholder="Ej: ABC 123" />

          <label class="form-label mt-2">Tipo de veh√≠culo</label>
          <select id="inTipo" class="form-select">
            <option value="auto">Auto</option>
            <option value="moto">Moto</option>
            <option value="bicicleta">Bicicleta</option>
          </select>

          <button id="btnAbrir" class="btn btn-success mt-3">Abrir ticket</button>
        </div>
      </section>

      <!-- Cerrar ticket -->
      <section class="col-12 col-lg-6">
        <div class="card">
          <h2>‚úÖ Cerrar ticket (Salida)</h2>

          <label class="form-label">Placa</label>
          <input id="outPlaca" class="form-control" placeholder="Ej: abc 123" />

          <label class="form-label mt-2">Tipo de pago</label>
          <div class="radio-group">
            <label><input type="radio" name="pay" value="efectivo" checked /> üíµ Efectivo</label>
            <label><input type="radio" name="pay" value="qr" /> üì± QR</label>
          </div>

          <button id="btnCerrar" class="btn btn-success mt-3">Cerrar ticket</button>
        </div>
      </section>
    </div>

    <!-- Abiertos -->
    <section class="card mt-4">
      <h2>‚è≥ Tickets abiertos</h2>
      <div class="table-wrap">
        <table class="table table-dark table-borderless align-middle">
          <thead>
            <tr><th>Placa</th><th>Tipo</th><th>Entrada</th><th>Estado</th></tr>
          </thead>
          <tbody id="tbodyAbiertos"></tbody>
        </table>
      </div>
      <p class="text-muted">Tip: las placas se normalizan (sin espacios y en MAY√öSCULAS) al guardar y al buscar.</p>
    </section>
  </main>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="auth.js"></script>

  <script>
    // OJO: no declaramos 'const supa' aqu√≠. Usamos el que ya define auth.js

    const ICON = (t) => t==='moto' ? 'üõµ Moto' : (t==='bicicleta' ? 'üö≤ Bicicleta' : 'üöó Auto');

    (async ()=>{
      await AuthUI.requireAuth();
      if (await ParkingAPI.isAdmin()) document.getElementById('linkAdmin').style.display='inline-flex';

      // abrir
      document.getElementById('btnAbrir').addEventListener('click', async ()=>{
        const placa = document.getElementById('inPlaca').value;
        const tipo  = document.getElementById('inTipo').value;
        try{
          await ParkingAPI.abrirTicket({ placa, tipoVehiculo: tipo });
          toast('Ticket abierto');
          document.getElementById('inPlaca').value='';
          await cargarAbiertos();
        }catch(e){ toast(e.message||String(e), false); }
      });

      // cerrar
      document.getElementById('btnCerrar').addEventListener('click', async ()=>{
        const placa = document.getElementById('outPlaca').value;
        const forma = document.querySelector('input[name="pay"]:checked').value;
        try{
          const res = await ParkingAPI.cerrarTicketPorPlaca(placa, forma);
          toast(`Ticket cerrado: ${res.formaPago} Bs ${res.costo.toFixed(2)}`);
          document.getElementById('outPlaca').value='';
          await cargarAbiertos();
        }catch(e){ toast(e.message||String(e), false); }
      });

      async function cargarAbiertos(){
        // usamos 'supa' global (definido en auth.js)
        const rows = await supa
          .from('tickets')
          .select('placa_vehiculo,tipo_vehiculo,hora_entrada,estado')
          .eq('estado','ingresado')
          .order('hora_entrada',{ascending:false});

        const tb = document.getElementById('tbodyAbiertos');
        if(rows.error){
          tb.innerHTML = `<tr><td colspan="4" class="text-muted">Error: ${rows.error.message}</td></tr>`;
          return;
        }
        tb.innerHTML = (rows.data||[]).map(r=>`
          <tr>
            <td class="mono">${r.placa_vehiculo}</td>
            <td>${ICON(r.tipo_vehiculo)}</td>
            <td>${new Date(r.hora_entrada).toLocaleString()}</td>
            <td><span class="badge badge-open">Abierto</span></td>
          </tr>
        `).join('') || `<tr><td colspan="4" class="text-muted">No hay tickets abiertos</td></tr>`;
      }

      // primera carga
      await cargarAbiertos();

      // toggle m√≥vil
      document.getElementById('menuToggle').addEventListener('click', ()=>{
        document.getElementById('navLinks').classList.toggle('open');
      });
    })();
  </script>
</body>
</html>
