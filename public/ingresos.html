<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Entradas / Salidas</title>
  <link rel="stylesheet" href="style.css" />
  <div id="toast" class="toast"></div>
</head>
<body>
  <nav class="topbar">
    <strong>ğŸš˜ ParqueoApp</strong>
    <span id="currentUser"></span>
    <div class="spacer"></div>
    <div class="nav-links">
      <a href="dashboard.html">ğŸ  Dashboard</a>
      <a href="tarifas.html">ğŸ’² Tarifas</a>
      <a href="extras.html">â• Ingresos extra</a>
      <button onclick="AuthUI.logout()">Salir</button>
    </div>
    <button class="menu-toggle" id="menuToggle">â˜°</button>
  </nav>
  <div class="mobile-menu" id="mobileMenu">
    <a href="dashboard.html">ğŸ  Dashboard</a>
    <a href="tarifas.html">ğŸ’² Tarifas</a>
    <a href="extras.html">â• Ingresos extra</a>
    <button onclick="AuthUI.logout()">Salir</button>
  </div>

  <main class="container">
    <div class="row g-3">
      <section class="col-12 col-md-6">
        <div class="card">
          <h2>â• Abrir ticket (Entrada)</h2>
          <form id="formEntrada" class="row g-3">
            <div class="col-12">
              <label class="form-label">Placa</label>
              <input name="placa" class="form-control" placeholder="Ej: ABC 123" required />
            </div>
            <div class="col-12">
              <label class="form-label">Tipo de vehÃ­culo</label>
              <select name="tipoVehiculo" class="form-select">
                <option value="auto">Auto</option>
                <option value="moto">Moto</option>
              </select>
            </div>
            <div class="col-12 d-grid">
              <button type="submit" class="btn btn-primary">Abrir ticket</button>
            </div>
          </form>
          <p id="infoEntrada" class="text-muted mt-2"></p>
        </div>
      </section>

      <section class="col-12 col-md-6">
        <div class="card">
          <h2>âœ”ï¸ Cerrar ticket (Salida)</h2>
          <form id="formSalida" class="row g-3">
            <div class="col-12">
              <label class="form-label">Placa</label>
              <input name="placa" class="form-control" placeholder="Ej: abc 123" required />
            </div>
            <div class="col-12">
              <label class="form-label">Tipo de pago</label>
              <div class="d-flex gap-3">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="tipoPago" id="pagoEfe" value="efectivo" checked>
                  <label class="form-check-label" for="pagoEfe">ğŸª™ Efectivo</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="tipoPago" id="pagoQR" value="qr">
                  <label class="form-check-label" for="pagoQR">ğŸ“± QR</label>
                </div>
              </div>
            </div>
            <div class="col-12 d-grid">
              <button type="submit" class="btn btn-primary">Cerrar ticket</button>
            </div>
          </form>
          <p id="infoSalida" class="text-muted mt-2"></p>
        </div>
      </section>
    </div>

    <section class="card">
      <h2>âŒ› Tickets abiertos</h2>
      <div class="table-wrap">
        <table class="table table-dark table-borderless align-middle">
          <thead>
            <tr>
              <th>Placa</th><th>Tipo</th><th>Entrada</th><th>Estado</th>
            </tr>
          </thead>
          <tbody id="tbodyAbiertos"></tbody>
        </table>
      </div>
      <p class="text-muted">Tip: las placas se normalizan (sin espacios y en MAYÃšSCULAS) al guardar y al buscar.</p>
    </section>
  </main>

  <script>
    const menuToggle=document.getElementById('menuToggle');
    const mobileMenu=document.getElementById('mobileMenu');
    menuToggle?.addEventListener('click',()=>document.body.classList.toggle('mobile-open'));
    mobileMenu?.addEventListener('click',()=>document.body.classList.remove('mobile-open'));
  </script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="auth.js"></script>
  <script>
    (async () => {
      await AuthUI.requireAuth();

      document.querySelectorAll('input[name="placa"]').forEach(inp=>{
        inp.addEventListener('input', ()=>{ inp.value = inp.value.toUpperCase(); });
      });

      const infoEntrada = document.getElementById('infoEntrada');
      const infoSalida  = document.getElementById('infoSalida');

      document.getElementById('formEntrada').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const f = e.target;
        try{
          const id = await ParkingAPI.abrirTicket({
            placa: f.placa.value,
            tipoVehiculo: f.tipoVehiculo.value
          });
          infoEntrada.textContent = 'âœ… Ticket abierto: ' + id;
          toast('Ticket abierto');
          f.reset();
          renderAbiertos();
        }catch(err){
          const msg = err?.message || String(err);
          infoEntrada.textContent = 'âŒ ' + msg;
          toast(msg,false);
        }
      });

      document.getElementById('formSalida').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const f = e.target;
        try{
          const pago = f.tipoPago.value || 'efectivo';
          const { id, costo, tipo_pago } = await ParkingAPI.cerrarTicketPorPlaca(f.placa.value, pago);
          infoSalida.textContent = `âœ… Ticket cerrado: ${id} â€” Total: ${costo} â€” Pago: ${tipo_pago}`;
          toast('Ticket cerrado: '+costo);
          f.reset();
          renderAbiertos();
        }catch(err){
          const msg = err?.message || String(err);
          infoSalida.textContent = 'âŒ ' + msg;
          toast(msg,false);
        }
      });

      async function renderAbiertos(){
        try{
          const rows = (await ParkingAPI.listarUltimosTickets(200)).filter(r => r.estado === 'ingresado');
          const tb = document.getElementById('tbodyAbiertos');
          tb.innerHTML = rows.length ? rows.map(r=>`
            <tr>
              <td class="mono">${r.placa_vehiculo}</td>
              <td>${r.tipo_vehiculo === 'moto' ? 'ğŸ›µ Moto' : 'ğŸš— Auto'}</td>
              <td>${r.hora_entrada ? new Date(r.hora_entrada).toLocaleString() : '-'}</td>
              <td><span class="badge badge-open">Abierto âŒ›</span></td>
            </tr>`).join('') : `<tr><td colspan="4" class="text-muted">No hay tickets abiertos</td></tr>`;
        }catch(e){ console.error(e); }
      }

      renderAbiertos();
    })();
  </script>
</body>
</html>
