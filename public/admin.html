<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ¬∑ ParqueoApp</title>
  <link rel="stylesheet" href="style.css" />
  <div id="toast" class="toast"></div>
  <style>
    .cards{display:grid;gap:14px;grid-template-columns:1fr}
    @media(min-width:992px){.cards{grid-template-columns:repeat(4,1fr)}}
    .card{background:#0b1220;border:1px solid #1f2937;border-radius:16px;padding:16px}
    .kpi{display:flex;align-items:center;gap:12px}
    .k-name{color:#9fb0c5;font-size:12px}
    .value{font-weight:800;font-size:22px}
    .mono{font-variant-numeric:tabular-nums}
    .table-wrap{overflow:auto}
  </style>
</head>
<body>
  <nav class="topbar">
    <strong>üõ°Ô∏è Admin</strong>
    <span id="currentUser"></span>
    <div class="spacer"></div>
    <button id="menuToggle" class="menu-toggle">‚ò∞</button>
    <div id="navLinks" class="links">
      <a href="dashboard.html">üè† Dashboard</a>
      <a href="ingresos.html">üöò Tickets</a>
      <a href="planes.html">üìÖ Planes</a>
      <a href="tarifas.html">üí≤ Tarifas</a>
      <button onclick="AuthUI.logout()">Salir</button>
    </div>
  </nav>

  <main class="container">
    <section class="card">
      <div class="row g-3">
        <div class="col-12 col-lg-3">
          <label class="form-label">Per√≠odo</label>
          <select id="periodo" class="form-select">
            <option value="daily">Hoy</option>
            <option value="weekly" selected>Esta semana</option>
            <option value="monthly">Este mes</option>
            <option value="yearly">Este a√±o</option>
            <option value="alltime">Todo</option>
          </select>
        </div>
        <div class="col-12 col-lg-3 d-grid align-end">
          <label class="form-label">&nbsp;</label>
          <button id="btnRefrescar" class="btn btn-primary">Refrescar</button>
        </div>
      </div>
    </section>

    <section class="cards mt-3">
      <div class="card kpi">
        <div>
          <div class="k-name">Tickets abiertos</div>
          <div id="kpiAbiertos" class="value">0</div>
        </div>
      </div>
      <div class="card kpi">
        <div>
          <div class="k-name">Ingresos por tickets</div>
          <div id="kpiIngT" class="value mono">0.00</div>
        </div>
      </div>
      <div class="card kpi">
        <div>
          <div class="k-name">Ingresos extra</div>
          <div id="kpiIngX" class="value mono">0.00</div>
        </div>
      </div>
      <div class="card kpi">
        <div>
          <div class="k-name">Egresos</div>
          <div id="kpiEgr" class="value mono">0.00</div>
        </div>
      </div>
    </section>

    <section class="card mt-3">
      <h3>Neto del per√≠odo</h3>
      <div id="kpiNeto" class="value mono">0.00</div>
    </section>

    <section class="card mt-3">
      <h3>Por operador</h3>
      <div class="table-wrap">
        <table class="table table-dark table-borderless align-middle">
          <thead><tr><th>Operador</th><th class="text-end">Tickets</th><th class="text-end">Monto Tickets</th><th class="text-end">Ingresos Extra</th></tr></thead>
          <tbody id="tbodyOp"></tbody>
        </table>
      </div>
    </section>

    <section class="card mt-3">
      <h3>Pagos recientes</h3>
      <div class="table-wrap">
        <table class="table table-dark table-borderless align-middle">
          <thead><tr><th>Placa</th><th>Tipo</th><th>Entrada</th><th>Salida</th><th class="text-end">Total (Bs)</th></tr></thead>
        <tbody id="tbodyRec"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="auth.js"></script>
  <script>
    const N = (x)=> Number(x||0);

    (async ()=>{
      await AuthUI.requireAdmin();

      document.getElementById('menuToggle').addEventListener('click', ()=>{
        document.getElementById('navLinks').classList.toggle('open');
      });

      document.getElementById('btnRefrescar').addEventListener('click', loadTodo);
      document.getElementById('periodo').addEventListener('change', loadTodo);

      await loadTodo();

      async function loadTodo(){
        const preset = document.getElementById('periodo').value;
        const { startISO, endISO } = ParkingAPI.rango(preset);

        const res = await ParkingAPI.adminResumenRango({ startISO, endISO });

        document.getElementById('kpiAbiertos').textContent = res.abiertos;
        document.getElementById('kpiIngT').textContent = N(res.ingresosTickets).toFixed(2);
        document.getElementById('kpiIngX').textContent = N(res.ingresosExtra).toFixed(2);
        document.getElementById('kpiEgr').textContent  = N(res.egresos).toFixed(2);
        document.getElementById('kpiNeto').textContent = N(res.neto).toFixed(2);

        const tbOp = document.getElementById('tbodyOp');
        tbOp.innerHTML = (res.porOperador||[]).map(o=>`
          <tr>
            <td>${o.nombre||'‚Äî'}</td>
            <td class="text-end mono">${o.tickets||0}</td>
            <td class="text-end mono">${N(o.monto).toFixed(2)}</td>
            <td class="text-end mono">${N(o.extra||0).toFixed(2)}</td>
          </tr>
        `).join('') || `<tr><td colspan="4" class="text-muted">Sin datos</td></tr>`;

        const tbR = document.getElementById('tbodyRec');
        tbR.innerHTML = (res.recientes||[]).map(t=>`
          <tr>
            <td class="mono">${t.placa_vehiculo}</td>
            <td>${t.tipo_vehiculo}</td>
            <td>${t.hora_entrada ? new Date(t.hora_entrada).toLocaleString() : '-'}</td>
            <td>${t.hora_salida  ? new Date(t.hora_salida ).toLocaleString() : '-'}</td>
            <td class="text-end mono">${N(t.costo_total).toFixed(2)}</td>
          </tr>
        `).join('') || `<tr><td colspan="5" class="text-muted">Sin pagos en el per√≠odo</td></tr>`;
      }
    })();
  </script>
</body>
</html>
