<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planes ¬∑ ParqueoApp</title>
  <link rel="stylesheet" href="style.css" />
  <div id="toast" class="toast"></div>
  <style>
    .card{background:#0b1220;border:1px solid #1f2937;border-radius:14px;padding:16px}
    .table-wrap{overflow:auto}
  </style>
</head>
<body>
  <nav class="topbar">
    <strong>üìÖ Planes</strong>
    <span id="currentUser"></span>
    <div class="spacer"></div>
    <button id="menuToggle" class="menu-toggle">‚ò∞</button>
    <div id="navLinks" class="links">
      <a href="dashboard.html">üè† Dashboard</a>
      <a href="ingresos.html">üöò Tickets</a>
      <a href="tarifas.html">üí≤ Tarifas</a>
      <a href="admin.html">üõ°Ô∏è Admin</a>
      <button onclick="AuthUI.logout()">Salir</button>
    </div>
  </nav>

  <main class="container">

    <section class="card">
      <h2>‚ûï Asignar plan a placa</h2>
      <div class="row g-3">
        <div class="col-12 col-lg-3">
          <label class="form-label">Placa</label>
          <input id="plPlaca" class="form-control" placeholder="ABC 123" />
        </div>
        <div class="col-12 col-lg-4">
          <label class="form-label">Plan</label>
          <select id="plPlan" class="form-select"></select>
        </div>
        <div class="col-12 col-lg-3">
          <label class="form-label">Fecha inicio</label>
          <input id="plInicio" type="datetime-local" class="form-control" />
        </div>
        <div class="col-12 col-lg-2 d-grid">
          <label class="form-label">&nbsp;</label>
          <button id="btnPlan" class="btn btn-primary">Asignar</button>
        </div>
      </div>
      <p class="hint mt-2">Se desactiva el plan activo anterior de la placa y se crea uno nuevo en <code>vehiculos_planes</code>.</p>
    </section>

    <section class="card mt-3">
      <h3>üìã Asignaciones recientes</h3>
      <div class="table-wrap">
        <table class="table table-dark table-borderless align-middle">
          <thead><tr><th>Placa</th><th>Plan</th><th>Tipo</th><th>Precio</th><th>Duraci√≥n (d√≠as)</th><th>Inicio</th><th>Activo</th></tr></thead>
          <tbody id="tbodyPlanes"></tbody>
        </table>
      </div>
    </section>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="auth.js"></script>
  <script>
    (async ()=>{
      await AuthUI.requireAdmin();

      document.getElementById('menuToggle').addEventListener('click', ()=>{
        document.getElementById('navLinks').classList.toggle('open');
      });

      const selPlan = document.getElementById('plPlan');

      async function cargarCatalogo(){
        const planes = await ParkingAPI.catalogoPlanes();
        selPlan.innerHTML = (planes||[]).map(p =>
          `<option value="${p.id}">${p.nombre} ‚Äî Bs ${Number(p.precio||0).toFixed(2)} (${p.tipo})</option>`
        ).join('') || `<option disabled>No hay planes</option>`;
      }

      async function cargarAsignaciones(){
        const list = await ParkingAPI.listarAsignaciones();
        const tb = document.getElementById('tbodyPlanes');
        tb.innerHTML = (list||[]).map(r=>`
          <tr>
            <td class="mono">${r.placa}</td>
            <td>${r.plan}</td>
            <td>${r.tipo}</td>
            <td class="mono">${(r.precio??0).toFixed(2)}</td>
            <td class="mono">${r.duracion_dias ?? '-'}</td>
            <td>${r.fecha_inicio ? new Date(r.fecha_inicio).toLocaleString() : '-'}</td>
            <td>${r.activo ? '‚úÖ' : '‚Äî'}</td>
          </tr>
        `).join('') || `<tr><td colspan="7" class="text-muted">Sin asignaciones</td></tr>`;
      }

      document.getElementById('btnPlan').addEventListener('click', async ()=>{
        const placa = document.getElementById('plPlaca').value.trim();
        const plan_id = selPlan.value;
        const fi = document.getElementById('plInicio').value;
        if(!placa || !plan_id){ toast('Placa y plan son obligatorios', false); return; }
        try{
          await ParkingAPI.asignarPlanAPlaca({ placa, plan_id, fecha_inicio: fi ? new Date(fi).toISOString() : null });
          document.getElementById('plPlaca').value='';
          document.getElementById('plInicio').value='';
          await cargarAsignaciones();
        }catch(e){ toast(e.message||String(e), false); }
      });

      await cargarCatalogo();
      await cargarAsignaciones();
    })();
  </script>
</body>
</html>
