<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Parqueo Â· Tickets</title>
  <link rel="stylesheet" href="style.css"/>
  <div id="toast" class="toast"></div>
  <style>
    body{background:#0b1220}
    .card{background:#0f172a;border:1px solid #1f2937;border-radius:16px;padding:18px}
    .k{color:#9fb0c5;font-size:12px}
    .mono{font-variant-numeric:tabular-nums}
    .big{font-size:28px;font-weight:800}
  </style>
</head>
<body>
  <nav class="topbar">
    <strong>ðŸš˜ Tickets</strong>
    <div class="spacer"></div>
    <a href="dashboard.html">Panel</a>
    <a href="planes.html">Planes</a>
    <a href="tarifas.html">Tarifas</a>
    <button onclick="AuthUI.logout()">Salir</button>
  </nav>

  <main class="container">
    <!-- Abrir ticket -->
    <section class="card">
      <h3>âž• Abrir ticket</h3>
      <form id="formAbrir" class="row g-3">
        <div class="col-12 col-md-4">
          <label class="form-label">Placa</label>
          <input id="inPlaca" class="form-control" placeholder="ABC123" required />
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Tipo vehÃ­culo</label>
          <select id="inTipo" class="form-select">
            <option value="auto">Auto</option>
            <option value="moto">Moto</option>
            <option value="bicicleta">Bicicleta</option>
          </select>
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">CategorÃ­a</label>
          <select id="inCat" class="form-select">
            <option value="normal">Normal</option>
            <option value="frecuente">Frecuente</option>
          </select>
        </div>
        <div class="col-12 d-grid">
          <button class="btn btn-primary">Abrir</button>
        </div>
      </form>
    </section>

    <!-- Cerrar ticket -->
    <section class="card mt-3">
      <h3>âœ… Cerrar ticket</h3>
      <div class="row g-3">
        <div class="col-12 col-md-4">
          <label class="form-label">Placa abierta</label>
          <select id="cbPlacas" class="form-select"></select>
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">MÃ©todo de pago</label>
          <select id="inPago" class="form-select">
            <option value="efectivo" selected>Efectivo</option>
            <option value="qr">QR</option>
            <option value="plan">Plan</option>
          </select>
        </div>
        <div class="col-12 col-md-4 d-grid align-end">
          <label class="form-label">&nbsp;</label>
          <button id="btnPreview" class="btn btn-secondary">Previsualizar total</button>
        </div>

        <div class="col-12">
          <div class="k">Total estimado</div>
          <div id="previewTotal" class="big mono">â€”</div>
          <div id="previewDetalle" class="k" style="margin-top:4px"></div>
        </div>

        <div class="col-12 d-grid">
          <button id="btnCerrar" class="btn btn-success">Cerrar ticket</button>
        </div>
      </div>
    </section>

    <!-- Abiertos -->
    <section class="card mt-3">
      <h3>ðŸŸ¡ Tickets abiertos</h3>
      <div class="table-wrap">
        <table class="table table-dark table-borderless align-middle">
          <thead><tr><th>Placa</th><th>Tipo</th><th>Entrada</th><th>CategorÃ­a</th><th>AcciÃ³n</th></tr></thead>
          <tbody id="tbodyAbiertos"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="auth.js"></script>
  <script>
    (async ()=>{
      await AuthUI.requireLogin();

      // Pide permiso de notificaciones (una vez)
      try{ if(Notification && Notification.permission!=='granted'){ Notification.requestPermission(); } }catch(_){}

      const cbPlacas = document.getElementById('cbPlacas');
      const pvTotal  = document.getElementById('previewTotal');
      const pvDet    = document.getElementById('previewDetalle');

      // Cargar placas y tabla
      async function loadAbiertos(){
        const placas = await ParkingAPI.placasAbiertas();
        cbPlacas.innerHTML = placas.map(p=>`<option value="${p}">${p}</option>`).join('') || `<option value="">(sin abiertos)</option>`;
        // tabla
        const rows = await ParkingAPI.listarAbiertos();
        document.getElementById('tbodyAbiertos').innerHTML =
          rows.map(r=>`
            <tr>
              <td class="mono">${r.placa_vehiculo}</td>
              <td>${r.tipo_vehiculo}</td>
              <td>${new Date(r.hora_entrada).toLocaleString()}</td>
              <td>${r.categoria||'-'}</td>
              <td><button class="btn btn-sm btn-danger" data-id="${r.id}">Cerrar manual</button></td>
            </tr>`).join('') || `<tr><td colspan="5" class="text-muted">No hay tickets abiertos</td></tr>`;

        document.querySelectorAll('button[data-id]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            if(!confirm('Â¿Cerrar manualmente este ticket (0 Bs)?')) return;
            await ParkingAPI.cerrarTicketManual(btn.getAttribute('data-id'));
            await loadAbiertos();
          });
        });
      }

      // Abrir
      document.getElementById('formAbrir').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const placa = document.getElementById('inPlaca').value;
        const tipo  = document.getElementById('inTipo').value;
        const cat   = document.getElementById('inCat').value;
        try{
          await ParkingAPI.crearTicket({ placa, tipoVehiculo: tipo, categoria: cat });
          await loadAbiertos();
          e.target.reset();
        }catch(err){ toast(err.message||'No se pudo abrir el ticket', false); }
      });

      // Preview
      async function doPreview(){
        const placa = cbPlacas.value;
        if(!placa){ pvTotal.textContent='â€”'; pvDet.textContent=''; return; }
        try{
          const res = await ParkingAPI.previewCierre({ placa });
          pvTotal.textContent = (Number(res.total||0)).toFixed(2) + ' Bs';
          pvDet.textContent   = res.detalle || '';
          if(res.usaPlan){ document.getElementById('inPago').value = 'plan'; }
        }catch(err){
          pvTotal.textContent='â€”'; pvDet.textContent = err.message||'No se pudo previsualizar';
        }
      }
      cbPlacas.addEventListener('change', doPreview);
      document.getElementById('btnPreview').addEventListener('click', async (e)=>{ e.preventDefault(); await doPreview(); });

      // Cerrar
      document.getElementById('btnCerrar').addEventListener('click', async ()=>{
        const placa = cbPlacas.value;
        const pago  = document.getElementById('inPago').value;
        if(!placa){ toast('Selecciona una placa', false); return; }
        try{
          const prev = await ParkingAPI.previewCierre({ placa });
          const total = Number(prev.total||0);
          if(!confirm(`Se cerrarÃ¡ la placa ${placa} por ${total.toFixed(2)} Bs.\n\n${prev.detalle}\n\nÂ¿Confirmar?`)) return;

          const cobrado = await ParkingAPI.cerrarTicket({ placa, tipo_pago: pago });
          toast(`Cerrado Â· ${Number(cobrado||0).toFixed(2)} Bs`);
          pvTotal.textContent='â€”'; pvDet.textContent='';
          await loadAbiertos();
        }catch(err){ toast(err.message||'No se pudo cerrar', false); }
      });

      await loadAbiertos();
      await doPreview();
    })();
  </script>
</body>
</html>
