<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tarifas & Configuración</title>
<link rel="stylesheet" href="style.css" />
<div id="toast" class="toast"></div>
<style>
  .grid{display:grid;gap:16px}
  @media(min-width:992px){.grid{grid-template-columns:1fr 1fr}}
  .card h2{margin:0 0 8px}
  .muted{color:#94a3b8}
  .btn-save{background:#22c55e;border:0}
</style>
</head>
<body>
  <nav class="topbar">
    <strong>💲 Tarifas</strong>
    <span id="currentUser"></span>
    <div class="spacer"></div>
    <button id="menuToggle" class="menu-toggle">☰</button>
    <div id="navLinks" class="links">
      <a href="dashboard.html">🏠 Dashboard</a>
      <a href="ingresos.html">🚘 Tickets</a>
      <a href="planes.html">📅 Planes</a>
      <a class="active" href="tarifas.html">💲 Tarifas</a>
      <a href="extras.html">🧾 Ingresos extra</a>
      <button onclick="AuthUI.logout()">Salir</button>
    </div>
  </nav>

  <main class="container">
    <section class="grid">
      <div class="card">
        <h2>⏱️ Por hora</h2>
        <div class="row g-3">
          <div class="col-6">
            <label class="form-label">Primera hora (Bs)</label>
            <input id="p_primera" type="number" step="0.01" class="form-control">
          </div>
          <div class="col-6">
            <label class="form-label">Hora extra (Bs)</label>
            <input id="p_extra" type="number" step="0.01" class="form-control">
          </div>
        </div>
        <p class="muted mt-2">Se usa para modalidad <strong>por hora</strong> y para el excedente de <strong>noche</strong> después de la hora de corte.</p>
      </div>

      <div class="card">
        <h2>🌞 / 🌙 Planos (día, noche, día+noche)</h2>
        <div class="row g-3">
          <div class="col-6">
            <label class="form-label">Diario normal (Bs)</label>
            <input id="p_dn" type="number" step="0.01" class="form-control">
          </div>
          <div class="col-6">
            <label class="form-label">Diario frecuente (Bs)</label>
            <input id="p_df" type="number" step="0.01" class="form-control">
          </div>
          <div class="col-6">
            <label class="form-label">Noche plana (Bs)</label>
            <input id="p_noche" type="number" step="0.01" class="form-control">
          </div>
          <div class="col-6">
            <label class="form-label">Corte de noche (HH:mm)</label>
            <input id="hora_corte" type="time" class="form-control">
          </div>
          <div class="col-6">
            <label class="form-label">Día+Noche 22 (Bs)</label>
            <input id="p_dn22" type="number" step="0.01" class="form-control">
          </div>
          <div class="col-6">
            <label class="form-label">Día+Noche 25 (Bs)</label>
            <input id="p_dn25" type="number" step="0.01" class="form-control">
          </div>
        </div>
        <p class="muted mt-2">Los precios se aplican cuando eliges la modalidad al abrir ticket.</p>
      </div>
    </section>

    <button id="btnGuardar" class="btn btn-save mt-3">Guardar cambios</button>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="auth.js"></script>
  <script>
    (async ()=>{
      await AuthUI.requireAdmin();
      document.getElementById('menuToggle').addEventListener('click', ()=>document.getElementById('navLinks').classList.toggle('open'));

      const claves = [
        'precio_diario_normal','precio_diario_frecuente','precio_noche_plana',
        'precio_dia_noche_22','precio_dia_noche_25',
        'precio_primera_hora','precio_hora_extra','hora_corte_noche'
      ];
      const map = {p_dn:'precio_diario_normal', p_df:'precio_diario_frecuente', p_noche:'precio_noche_plana',
                   p_dn22:'precio_dia_noche_22', p_dn25:'precio_dia_noche_25',
                   p_primera:'precio_primera_hora', p_extra:'precio_hora_extra', hora_corte:'hora_corte_noche'};

      const { data } = await supa.from('configuracion').select('clave,valor').in('clave',claves);
      const cfg = Object.fromEntries((data||[]).map(r=>[r.clave,r.valor]));
      document.getElementById('p_dn').value = cfg['precio_diario_normal'] || 15;
      document.getElementById('p_df').value = cfg['precio_diario_frecuente'] || 12;
      document.getElementById('p_noche').value = cfg['precio_noche_plana'] || 12;
      document.getElementById('p_dn22').value = cfg['precio_dia_noche_22'] || 22;
      document.getElementById('p_dn25').value = cfg['precio_dia_noche_25'] || 25;
      document.getElementById('p_primera').value = cfg['precio_primera_hora'] || 7;
      document.getElementById('p_extra').value = cfg['precio_hora_extra'] || 1;
      document.getElementById('hora_corte').value = cfg['hora_corte_noche'] || '20:00';

      document.getElementById('btnGuardar').addEventListener('click', async ()=>{
        const rows = Object.entries(map).map(([id, clave])=>{
          const valor = document.getElementById(id).value;
          return { clave, valor };
        });
        try{
          for(const r of rows){
            const { error } = await supa.from('configuracion').upsert({ clave:r.clave, valor:String(r.valor) }, { onConflict:'clave' });
            if(error) throw error;
          }
          toast('Configuración guardada');
        }catch(e){ toast(e.message||String(e), false); }
      });
    })();
  </script>
</body>
</html>
