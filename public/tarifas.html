<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tarifas</title>
  <link rel="stylesheet" href="style.css" />
  <div id="toast" class="toast"></div>
</head>
<body>
  <nav class="topbar">
    <strong>ğŸš˜ ParqueoApp</strong>
    <span id="currentUser"></span>
    <div class="spacer"></div>

    <button id="menuToggle" class="menu-toggle">â˜°</button>
    <div id="navLinks" class="links">
      <a href="dashboard.html">ğŸ  Dashboard</a>
      <a href="ingresos.html">â• Entradas</a>
      <a href="admin.html" id="linkAdmin" style="display:none;">ğŸ›¡ï¸ Admin</a>
      <button onclick="AuthUI.logout()">Salir</button>
    </div>
  </nav>

  <main class="container">
    <section class="card">
      <h2>ğŸ’² Tarifas</h2>
      <div class="table-wrap">
        <table class="table table-dark table-borderless align-middle" id="tablaTarifas">
          <thead>
            <tr><th>Tipo</th><th>Primera hora</th><th>Hora extra</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="text-muted mt-2">Solo <strong>Admin</strong> puede actualizar si tu RLS lo exige.</p>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="auth.js"></script>
  <script>
    (async () => {
      await AuthUI.requireAuth();
      if (await ParkingAPI.isAdmin()) document.getElementById('linkAdmin').style.display='inline-flex';

      async function render(){
        try{
          const data = await ParkingAPI.listarTarifas();
          const tb = document.querySelector('#tablaTarifas tbody');
          tb.innerHTML = '';
          data.forEach(row=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${row.tipo_vehiculo === 'moto' ? 'ğŸ›µ Moto' : 'ğŸš— Auto'}</td>
              <td><input type="number" step="0.01" class="form-control" value="${row.precio_primera_hora}"></td>
              <td><input type="number" step="0.01" class="form-control" value="${row.precio_hora_extra}"></td>
              <td class="text-end"><button class="btn btn-primary btn-sm">ğŸ’¾ Guardar</button></td>
            `;
            tr.querySelector('button').addEventListener('click', async ()=>{
              const primera = tr.children[1].querySelector('input').value;
              const extra   = tr.children[2].querySelector('input').value;
              try{ await ParkingAPI.actualizarTarifa(row.tipo_vehiculo, primera, extra); toast('Tarifa actualizada'); }
              catch(e){ toast(e.message||String(e), false); }
            });
            tb.appendChild(tr);
          });
        }catch(e){ toast(e.message||String(e), false); }
      }
      render();
    })();
  </script>
</body>
</html>
