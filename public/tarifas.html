<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tarifas · ParqueoApp</title>
  <link rel="stylesheet" href="style.css" />
  <div id="toast" class="toast"></div>
  <style>
    .card{background:#0b1220;border:1px solid #1f2937;border-radius:14px;padding:16px}
    .table-wrap{overflow:auto}
    .mono{font-variant-numeric:tabular-nums}
  </style>
</head>
<body>
  <nav class="topbar">
    <strong>💲 Tarifas</strong>
    <span id="currentUser"></span>
    <div class="spacer"></div>
    <button id="menuToggle" class="menu-toggle">☰</button>
    <div id="navLinks" class="links">
      <a href="dashboard.html">🏠 Dashboard</a>
      <a href="ingresos.html">🚘 Tickets</a>
      <a href="planes.html">📅 Planes</a>
      <a href="admin.html">🛡️ Admin</a>
      <button onclick="AuthUI.logout()">Salir</button>
    </div>
  </nav>

  <main class="container">
    <section class="card">
      <h2>Tarifas por tipo de vehículo (plan por horas)</h2>
      <div class="table-wrap">
        <table class="table table-dark table-borderless align-middle">
          <thead><tr><th>Tipo</th><th class="text-end">Primera hora</th><th class="text-end">Hora extra</th><th class="text-end">Guardar</th></tr></thead>
          <tbody id="tbodyTarifas"></tbody>
        </table>
      </div>
      <p class="hint mt-2">
        <strong>Reglas vigentes:</strong> Día (08:00–19:59) → 15 normal / 12 frecuente. Noche (20:00–07:59) → 12.  
        Si no cerró y continúa, aplica <span class="mono">7</span> primera hora + <span class="mono">1</span> extra/h.
      </p>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="auth.js"></script>
  <script>
    (async ()=>{
      await AuthUI.requireAdmin();

      // Toggle menú
      document.getElementById('menuToggle').addEventListener('click', ()=>{
        document.getElementById('navLinks').classList.toggle('open');
      });

      const tarifas = await ParkingAPI.listarTarifas();
      const tb = document.getElementById('tbodyTarifas');
      tb.innerHTML = (tarifas||[]).map(t => `
        <tr data-id="${t.id}">
          <td>${t.tipo_vehiculo}</td>
          <td class="text-end"><input class="form-control form-control-sm text-end" value="${Number(t.precio_primera_hora||0).toFixed(2)}" /></td>
          <td class="text-end"><input class="form-control form-control-sm text-end" value="${Number(t.precio_hora_extra||0).toFixed(2)}" /></td>
          <td class="text-end"><button class="btn btn-primary btn-sm">Guardar</button></td>
        </tr>
      `).join('') || `<tr><td colspan="4" class="text-muted">Sin registros</td></tr>`;

      tb.querySelectorAll('button.btn').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const tr = btn.closest('tr'); const id = tr.getAttribute('data-id');
          const [inpPrimera, inpExtra] = tr.querySelectorAll('input');
          try{
            await ParkingAPI.actualizarTarifa(id, parseFloat(inpPrimera.value), parseFloat(inpExtra.value));
            toast('Tarifa actualizada');
          }catch(e){ toast(e.message||String(e), false); }
        });
      });
    })();
  </script>
</body>
</html>
